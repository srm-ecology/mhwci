---
title: "Plotting differences of rasters"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plotting differences of rasters}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::clean_cache(clean = TRUE)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(8, 6)
)

```

```{r setup}
library(magrittr)
library(mhwci)
library(ggplot2)

```

```{r create_rasters_from_db, echo=TRUE}

# read from the environment
db_file <- mhwci::get_dbfile()
print(db_file)
db<- mhwci::mhw_connect(db_file)

# this may take signifigant memory
arise10_raster_list <- durations_by_decade_raster(db, mhw_table = "arise10_decade_metrics")
arise15_raster_list <- durations_by_decade_raster(db, mhw_table = "arise15_decade_metrics")
ssp245_raster_list <- durations_by_decade_raster(db, mhw_table = "ssp245_decade_metrics")

ssp245_raster_list
```


```{r , echo=TRUE}
arise_diff <- ssp245_raster_list - arise15_raster_list 
plot_rasters_squish_outliers(arise_diff, 
                             title = "SSP2 4.5 minus ARISE1.5", 
                             subtitle = "",
                             scale_label = "", 
                             palette="water",
                             max_threshold_value = 500,
                             break_width = 50
                             )

```


There is not a red-white-blue color scheme, this is using the 'water' palette.  You could also try the 'blues' palette. 


### Difference Density plots

This is not the best way to do this.   The density plot requires the database to be in 'long form' or 
```
value decade
 3     2040
 2     2040
 ...
 3.1   2050
 etc
 ```
 
This does not remove outliers so it's hard to visualize 

Note it requires the 'reshape' package, which you may have to install

```{r}
DBI::dbDisconnect(db)
library(reshape)
```


```{r, echo=TRUE}

diff_values<- data.frame(lapply(arise_diff, terra::values))
names(diff_values)<- decades  
diff_values_long_form <- na.omit(reshape::melt(diff_values))

#plot full range of difference, which includes a huge range

g<- ggplot(diff_values_long_form , aes(x=value, fill=variable)) + geom_density(na.rm = TRUE, alpha = 0.25)
print(g)

# this just strips out the outliers, which removes data, but it looks nicer
g+ xlim(-100, 500)


```

## Plotting differences of other metrics

Currently this package has functions that only compute summaries of duration, 
which were created at beginning as we designed the workflow. 

There is a generic function `mhw_metric_summary_sql()` 

### Example run for one decade:

Calculate the differences of the **max of max intensity** (extremes) only for **2040 to 2049**

```{r, echo=TRUE}

# in thse two function calls, all the parameters are the same
valid_ensembles <- "006,007,008,009,010"
arise15_sql <- mhw_metric_summary_sql(mhw_table = "arise15_decade_metrics", 
                            mhw_metric = 'int_max', 
                            sql_function = 'max', 
                            start_year=2040, 
                            end_year=2049,
                            ensemble_list_string = valid_ensembles) 

arise15_raster <- summary_metrics_raster(db, arise15_sql)

## --- 
ssp245_sql <- mhw_metric_summary_sql(mhw_table = "ssp245_decade_metrics", 
                            mhw_metric = 'int_max', 
                            sql_function = 'max', 
                            start_year=2040, 
                            end_year=2049,
                            ensemble_list_string = valid_ensembles) 
  
ssp245_raster <-  summary_metrics_raster(db, ssp245_sql)
arise_max_int_diff <- ssp245_raster - arise15_raster
plot(arise_max_int_diff, main = "difference max of max intensity, \nSSP2 4.5 - ARISE 1.5, \n2040-2049")

```


```{r}

DBI::dbDisconnect(db)
```